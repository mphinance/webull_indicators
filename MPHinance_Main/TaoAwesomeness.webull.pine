// MPHinace I changed and added stuff for webull desktop
// Saty Pivot Ribbon
// Copyright (C) 2022 Saty Mahajan
// A 3 EMA Ribbon system that simplifies measuring and using emas for trend and support/resistance.
// Special thanks to Ripster for his education and EMA Clouds which inspired this indicator.

// --- EMA Inputs ---
fast_ema = define(8, name="Fast EMA", min=1)
pivot_ema = define(21, name="Pivot EMA", min=1)
slow_ema = define(34, name="Slow EMA", min=1)
ema55_len = define(55, name="EMA 55 Length", min=1)
ema89_len = define(89, name="EMA 89 Length", min=1)

// --- Keltner Channel Inputs ---
atr_len = define(14, name="ATR Length (Keltner)", min=1)

// --- Stochastic Inputs ---
stoch_k_len = define(8, name="Stochastic %K Length", min=1)
stoch_d_len = define(3, name="Stochastic %D Length", min=1)

// --- RSI Input for Entry Triggers ---
rsi_len = define(2, name="RSI Length (Entry Trigger)", min=1)

// --- Calculate EMAs ---
fast_ema_value = ind.ema(close, fast_ema)
pivot_ema_value = ind.ema(close, pivot_ema) // This is our 21 EMA, used as Keltner middle line
slow_ema_value = ind.ema(close, slow_ema)
ema55_value = ind.ema(close, ema55_len)
ema89_value = ind.ema(close, ema89_len)

// --- Calculate ATR for Keltner Channels ---
atr_value = ind.atr(atr_len)

// --- Calculate Keltner Channel Bands (based on 21 EMA) ---
kc_upper1 = pivot_ema_value + (1 * atr_value)
kc_lower1 = pivot_ema_value - (1 * atr_value)
kc_upper2 = pivot_ema_value + (2 * atr_value)
kc_lower2 = pivot_ema_value - (2 * atr_value)
kc_upper3 = pivot_ema_value + (3 * atr_value)
kc_lower3 = pivot_ema_value - (3 * atr_value)

// --- Calculate Slow Stochastics (8,3) ---
stoch_k_value = ind.stoch(stoch_k_len, stoch_d_len)
stoch_d_value = ind.stoch(stoch_k_len, stoch_d_len, true) // Assuming the third parameter gets Slow %D, if not, remove it.

// --- Calculate RSI(2) for Entry Triggers ---
rsi_value = ind.rsi(close, rsi_len)

// --- Define Entry Zone Condition ---
// Stock within +/- 1 ATR of the mean (21 EMA)
is_in_entry_zone = close >= kc_lower1 and close <= kc_upper1

// --- Define RSI Entry Triggers ---
// Bullish: RSI(2) dips below 10 and then crosses back above 10.
bullish_rsi_trigger = (rsi_value[1] <= 10) and (rsi_value > 10)

// Bearish: RSI(2) rises above 90 and then crosses back below 90.
bearish_rsi_trigger = (rsi_value[1] >= 90) and (rsi_value < 90)

// --- Plot EMAs (hidden, used for fill) ---
// Using color.gray for lines as transparency with color.rgb is not working as expected.
p_fast = plt(fast_ema_value, name="Fast EMA", color=color.gray)
p_pivot = plt(pivot_ema_value, name="Pivot EMA", color=color.gray)
p_slow = plt(slow_ema_value, name="Slow EMA", color=color.gray)
p_ema55 = plt(ema55_value, name="EMA 55", color=color.gray)
p_ema89 = plt(ema89_value, name="EMA 89", color=color.gray)

// --- Plot Keltner Channel Bands ---
// Using color.teal for the Keltner bands. Varying line_width for distinction.
plt(kc_upper1, name="KC Upper 1", color=color.teal, line_width=1)
plt(kc_lower1, name="KC Lower 1", color=color.teal, line_width=1)
plt(kc_upper2, name="KC Upper 2", color=color.teal, line_width=2)
plt(kc_lower2, name="KC Lower 2", color=color.teal, line_width=2)
plt(kc_upper3, name="KC Upper 3", color=color.teal, line_width=3)
plt(kc_lower3, name="KC Lower 3", color=color.teal, line_width=3)

// --- Plot Slow Stochastics ---
// Plot %K line, with color based on bullish/bearish setup conditions
stoch_plot_color = iff(stoch_k_value <= 40, color.lime, // Bullish setup (buy the dip)
                   iff(stoch_k_value >= 60, color.fuchsia, // Bearish setup (sell the rip)
                   color.gray)) // Default color when not in setup zone

plt(stoch_k_value, name="Slow Stoch %K", color=stoch_plot_color)
plt(stoch_d_value, name="Slow Stoch %D", color=color.white) // %D line, typically white or another contrasting color

// --- Plot Stochastic Overbought/Oversold Levels ---
hline(80, name="Overbought", color=color.red, line_width=1, type=hline.type_dotted)
hline(20, name="Oversold", color=color.green, line_width=1, type=hline.type_dotted)

// --- Plot Entry Triggers on Main Chart ---
// Plot bullish entry marker below the low of the bar
plt(iff(is_in_entry_zone and bullish_rsi_trigger, low - (atr_value * 0.5), none),
    name="Bullish Entry Trigger",
    type=plt.type_circles,
    color=color.lime,
    line_width=2)

// Plot bearish entry marker above the high of the bar
plt(iff(is_in_entry_zone and bearish_rsi_trigger, high + (atr_value * 0.5), none),
    name="Bearish Entry Trigger",
    type=plt.type_circles,
    color=color.red,
    line_width=2)

// --- Define Fill Colors based on conditions for EMAs (Original colors) ---
fill_color_fp = iff(fast_ema_value >= pivot_ema_value, color.green, color.red)
fill_color_ps = iff(pivot_ema_value >= slow_ema_value, color.blue, color.orange)

// --- Fill between EMA lines to create "ribbon" effect ---
plt.fill_between(p_fast, p_pivot, color=fill_color_fp, opacity=40, name="Fast-Pivot Fill")
plt.fill_between(p_pivot, p_slow, color=fill_color_ps, opacity=40, name="Pivot-Slow Fill")
